@model DocumentOverviewViewModel

<form id="form-document" method="post">
    <div class="table-wrapper-double-scroll">
        <table class="table table-bordered table-hover tbl-documents table-view-pharus">
            <thead>
                <tr>
                    <th>
                        @SharedLocalizer["File Description"]
                    </th>
                    <th>
                        @SharedLocalizer["Valid From:"]
                    </th>
                    <th>
                        @SharedLocalizer["Valid Until:"]
                    </th>
                    <th>
                        @SharedLocalizer["File Name"]
                    </th>
                    <th>
                        @SharedLocalizer["File Type"]
                    </th>
                    @if (this.User.IsInRole(GlobalConstants.AdministratorRoleName) || this.User.IsInRole(GlobalConstants.LegalRoleName))
                    {
                        <th>
                            @SharedLocalizer["Actions"]
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var document in Model.Documents)
                {
                    <tr class="@document.FileId">
                        <td class="p-1">
                            @document.Description
                        </td>
                        <td class="p-1">
                            @document.ValidFrom
                        </td>
                        <td class="p-1">
                            @document.ValidUntil
                        </td>
                        <td class="p-1">
                            <button class="btn-link-pharus text-left"
                                    formtarget="_blank"
                                    type="submit"
                                    asp-area=""
                                    asp-route="files"
                                    asp-route-name="@document.SluggedName"
                                    name="docValue"
                                    value="@document.Name">
                                @Html.Encode(@System.IO.Path.GetFileNameWithoutExtension(document.Name))
                            </button>
                        </td>
                        <td class="p-1">
                            @document.Type
                        </td>
                        @if (this.User.IsInRole(GlobalConstants.AdministratorRoleName) || this.User.IsInRole(GlobalConstants.LegalRoleName))
                        {
                            <td class="p-1 text-center">
                                <button type="button" class="btn btn-pharus btn-sm mr-1 btn-delete">
                                    @SharedLocalizer["Delete"]
                                </button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
        <input type="hidden" name="AreaName" value="@Model.AreaName" />
    </div>
</form>

<script>
    $(function () {
        // ________________________________________________________
        //
        // Double top scroll for wide table
        $('.double-scroll').doubleScroll();
        $('.table-wrapper-double-scroll').doubleScroll({ resetOnWindowResize: true });
    })
    // ________________________________________________________
    //
    // Delete selected row from documents table by confirming

    $('.btn-delete').on('click', function () {
        const tokenDoc = $('#form-document input[name=__RequestVerificationToken]').val();
        const areaName = '@Model.AreaName';
        const docValue = $(this).closest('tr').find('button').eq(0).val();
        const fileId = $(this).closest('tr').attr('class');

         const MESSAGES_DOC = {
            TITLE: '@Html.Raw(SharedLocalizer["Are you sure?"].Value.ToString())',
            TEXT: '@Html.Raw(SharedLocalizer["Once deleted, you will not be able to recover this file!"].Value.ToString())',
            BTN_CANCEL: '@Html.Raw(SharedLocalizer["Cancel"].Value.ToString())',
            TITLE_FAIL: '@Html.Raw(SharedLocalizer["Error deleting!"].Value.ToString())',
            TEXT_FAIL: '@Html.Raw(SharedLocalizer["Please try again"].Value.ToString())',
            TITLE_SUCCESS: '@Html.Raw(SharedLocalizer["Your file has been deleted!"].Value.ToString())'
        };

        var jqXhr = $.ajax({
            type: 'GET',
            url: '/media/delete',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            headers: { 'X-CSRF-TOKEN': tokenDoc },
            data: { fileId: fileId, docValue: docValue, areaName: areaName }
        });

        swal({
            title: MESSAGES_DOC.TITLE,
            text: MESSAGES_DOC.TEXT,
            icon: "warning",
            buttons: [MESSAGES_DOC.BTN_CANCEL, "OK"],
            dangerMode: true
        }).then((isConfirm) => {
            if (!isConfirm) return;
            jqXhr
            .done(function (data) {
                if (data.fileId == 'false') {
                    swal({
                        title: MESSAGES_DOC.TITLE_FAIL,
                        text: MESSAGES_DOC.TEXT_FAIL,
                        icon: "error",
                    });
                    return false;
                }
                $('.tbl-documents .' + data.fileId).remove();
                $('.tbl-distinct-documents .' + data.fileId).remove();
                swal(MESSAGES_DOC.TITLE_SUCCESS, {
                    icon: "success",
                });
            })
            .fail(function (request, status, error) {
                swal(request.responseText, {
                    icon: "error"})
            });
        });
    });
</script>