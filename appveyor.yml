#---------------------------------#
#      general configuration      #
#---------------------------------#
version: 1.0.{build}
os: Visual Studio 2019
configuration: Release
branches:
  only:
  - master
  - develop

#---------------------------------#
#    environment configuration    #
#---------------------------------#
init:
- net start MSSQL$SQL2019
[reflection.assembly]::LoadWithPartialName("Microsoft.SqlServer.Smo") | Out-Null
[reflection.assembly]::LoadWithPartialName("Microsoft.SqlServer.SqlWmiManagement") | Out-Null

$serverName = $env:COMPUTERNAME
$instanceName = 'SQL2008R2SP2'
$smo = 'Microsoft.SqlServer.Management.Smo.'
$wmi = new-object ($smo + 'Wmi.ManagedComputer')

# Enable TCP/IP
$uri = "ManagedComputer[@Name='$serverName']/ServerInstance[@Name='$instanceName']/ServerProtocol[@Name='Tcp']"
$Tcp = $wmi.GetSmoObject($uri)
$Tcp.IsEnabled = $true
$TCP.alter()

# Enable named pipes
$uri = "ManagedComputer[@Name='$serverName']/ ServerInstance[@Name='$instanceName']/ServerProtocol[@Name='Np']"
$Np = $wmi.GetSmoObject($uri)
$Np.IsEnabled = $true
$Np.Alter()

# Set Alias
New-Item HKLM:\SOFTWARE\Microsoft\MSSQLServer\Client -Name ConnectTo | Out-Null
Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\MSSQLServer\Client\ConnectTo -Name '(local)' -Value "DBMSSOCN,$serverName\$instanceName" | Out-Null

# Start services
Set-Service SQLBrowser -StartupType Manual
Start-Service SQLBrowser
Start-Service "MSSQL`$$instanceName"

#---------------------------------#
#       build configuration       #
#---------------------------------#
before_build:
- nuget install redis-64 -excludeversion
- redis-64\tools\redis-server.exe --service-install
- redis-64\tools\redis-server.exe --service-start --port 6379
- dotnet restore src\DataGate\DataGate.sln
build:
  project: src\DataGate\DataGate.sln
  verbosity: minimal
  
#---------------------------------#
#       tests configuration       #
#---------------------------------#

test_script:
- cmd: dotnet test "src\DataGate\Tests\DataGate.Services.Tests\DataGate.Services.Tests.csproj" --configuration Release --no-build
      
#---------------------------------#
#        global handlers          #
#---------------------------------#

on_finish:
  - redis-64\tools\redis-server.exe --service-stop
  
  
